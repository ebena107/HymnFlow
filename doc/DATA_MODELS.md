# HymnFlow Data Models

Complete schema definitions and examples for HymnFlow data structures.

---

## Hymn Object Model

Complete definition of the hymn data structure stored in localStorage.

### Schema

```typescript
interface Hymn {
  // ========================================
  // REQUIRED FIELDS
  // ========================================
  id: string;                    // Unique identifier (immutable)
  title: string;                 // Hymn title (non-empty)
  verses: string[];              // Array of verse texts (min 1, non-empty)

  // ========================================
  // OPTIONAL FIELDS
  // ========================================
  author?: string;               // Hymn author/composer
  chorus?: string;               // Optional chorus text
  metadata?: {                   // Additional metadata
    number?: number;             // Hymn number (e.g., 123) - searchable, displayed in UI
    sourceAbbr?: string;         // Source abbreviation (e.g., "CH", "PD", "HB") - displayed with number
    category?: string;           // Reserved: Category (e.g., "Gospel", "Praise")
    key?: string;                // Reserved: Musical key (e.g., "G", "Bb")
    tempo?: string;              // Reserved: Tempo marking (e.g., "Moderate")
    source?: string;             // Source/origin of hymn (e.g., "Public Domain", "Hymnary.org")
    [key: string]: any;          // Future metadata fields
  };
  createdAt?: string;            // ISO8601 timestamp
}
```

---

## Complete Hymn Example

```javascript
{
  id: "hymn_1704549696123_0_a7b2c9d1",
  title: "Amazing Grace",
  author: "John Newton",
  verses: [
    "Amazing grace! How sweet the sound\nThat saved a wretch like me!\nI once was lost, but now am found,\nWas blind, but now I see.",
    "'Twas grace that taught my heart to fear,\nAnd grace my fears relieved;\nHow precious did that grace appear\nThe hour I first believed!",
    "Through many dangers, toils and snares,\nI have already come;\n'Tis grace has brought me safe thus far,\nAnd grace will lead me home.",
    "When we've been there ten thousand years,\nBright shining as the sun,\nWe've no less days to sing God's praise\nThan when we'd first begun."
  ],
  chorus: "Amazing grace, how sweet the sound",
  metadata: {
    number: 1,
    sourceAbbr: "CH",
    category: "Gospel",
    key: "G",
    tempo: "Moderate",
    source: "Church Hymnal"
  },
  createdAt: "2024-01-06T12:34:56.789Z"
}
```

---

## Field Definitions

### `id` (Required, String)

**Format:** `hymn_<timestamp>_<counter>_<random>`

**Example:** `hymn_1704549696123_0_a7b2c9d1`

**Rules:**
- Starts with `hymn_`
- Generated by `generateUniqueHymnId()` function
- Immutable (never change once set)
- Unique across entire hymn library
- Used to identify hymn in services/setlists

**Usage:**
```javascript
// In import handlers
const newHymn = {
  id: generateUniqueHymnId(),  // Auto-generated
  title: "New Hymn",
  // ...
};

// To find a hymn
const hymn = hymns.find(h => h.id === hymnId);
```

---

### `title` (Required, String)

**Rules:**
- Non-empty (after trim)
- Maximum recommended: 100 characters
- Case-sensitive
- Can contain: letters, numbers, spaces, punctuation

**Valid Examples:**
- `"Amazing Grace"`
- `"His Eye Is on the Sparrow"`
- `"Jesus Loves Me (Children's Hymn)"`

**Invalid Examples:**
- `""` (empty)
- `"   "` (whitespace only)

**Usage:**
```javascript
// Validation
if (!hymn.title || !hymn.title.trim()) {
  throw new Error('Title is required');
}

// Display in UI
const displayTitle = escapeHtml(hymn.title);
```

---

### `verses` (Required, Array of Strings)

**Rules:**
- Array of strings (minimum 1 verse)
- Each verse non-empty after trim
- Line breaks within verse use `\n`
- No single verse should exceed ~500 characters

**Format:**
```javascript
verses: [
  "Line 1\nLine 2\nLine 3",  // Verse 1
  "Line 1\nLine 2\nLine 3",  // Verse 2
  "Line 1\nLine 2\nLine 3"   // Verse 3
]
```

**Example:**
```javascript
verses: [
  "Verse 1 Line 1\nVerse 1 Line 2\nVerse 1 Line 3\nVerse 1 Line 4",
  "Verse 2 Line 1\nVerse 2 Line 2\nVerse 2 Line 3",
  "Verse 3 Line 1\nVerse 3 Line 2"
]
```

**Display Logic:**
```javascript
// Get lines for display
const verseText = currentHymn.verses[currentVerse];
const lines = verseText.split('\n');
const displayLines = lines.slice(offset, offset + linesPerPage);
```

**Validation:**
```javascript
if (!Array.isArray(hymn.verses) || hymn.verses.length === 0) {
  throw new Error('At least one verse is required');
}

// Each verse must be non-empty
hymn.verses.forEach((verse, idx) => {
  if (typeof verse !== 'string' || !verse.trim()) {
    throw new Error(`Verse ${idx + 1} is empty`);
  }
});
```

---

### `author` (Optional, String)

**Rules:**
- String (can be empty `""`)
- Maximum recommended: 50 characters
- Displayed in hymn list as "Author • X verse(s)"

**Examples:**
- `"John Newton"`
- `"Isaac Watts"`
- `"Unknown"` (when author unknown)
- `""` (empty string when not provided)

**Default:**
```javascript
author: ""  // Empty string if not provided
```

**Usage in UI:**
```javascript
const displayAuthor = hymn.author || 'Unknown';
const html = `<div class="meta">${escapeHtml(displayAuthor)} • ${hymn.verses.length} verse(s)</div>`;
```

---

### `chorus` (Optional, String)

**Rules:**
- String (can be empty)
- Line breaks use `\n`
- Can be longer than individual verses

**Examples:**
```javascript
chorus: "Amazing grace, how sweet the sound"

chorus: "Chorus Line 1\nChorus Line 2\nChorus Line 3"

chorus: ""  // Empty if no chorus
```

**Future Usage:**
```javascript
// Currently: jump to chorus shows alert
function jumpToChorus() {
  if (!currentHymn || !currentHymn.chorus) {
    alert('No chorus available');
    return;
  }
  // TODO: Implement chorus display
  alert('Chorus: ' + currentHymn.chorus);
}

// Future: Display chorus as separate "verse"
// Could implement as verses[-1] or special chorus mode
```

---

### `metadata` (Optional, Object)

**Rules:**
- Optional object
- Can contain arbitrary key-value pairs
- New fields won't break existing functionality
- Reserved fields documented below

**Structure:**
```javascript
metadata: {
  number: 123,              // Optional: Hymn number
  sourceAbbr: "CH",         // Optional: Source abbreviation
  category: "Gospel",       // Reserved: Category
  key: "G",                 // Reserved: Musical key
  tempo: "Moderate",        // Reserved: Tempo
  source: "Church Hymnal", // Optional: Source/origin
  // Future fields can be added here
}
```

#### Metadata Fields

##### `number` (Integer)

**Usage:** Searchable hymn number, displayed in UI

**Format:** Positive integer or undefined

**Examples:**
```javascript
metadata: { number: 1 }      // Hymn #1
metadata: { number: 123 }    // Hymn #123
metadata: {}                 // No number
```

**Display in UI:**
```javascript
// Basic display
const hymnNumber = hymn.metadata?.number ? `${hymn.metadata.number} - ` : '';
const display = `${hymnNumber}${hymn.title}`;
// Result: "1 - Amazing Grace" or "Amazing Grace"

// Display with source abbreviation (recommended)
const sourceAbbr = hymn.metadata?.sourceAbbr || '';
const number = hymn.metadata?.number || '';
const hymnRef = (sourceAbbr && number) ? `${sourceAbbr} ${number} - ` : 
                (number ? `${number} - ` : '');
const display = `${hymnRef}${hymn.title}`;
// Result: "CH 1 - Amazing Grace" or "1 - Amazing Grace" or "Amazing Grace"
```

**Search Behavior:**
```javascript
// Search includes hymn number
if (hymn.metadata?.number?.toString().includes(query)) {
  // Matched
}
```

---

##### `sourceAbbr` (String)

**Usage:** Short abbreviation for hymn source, displayed with number for church references

**Format:** 1-5 character uppercase string (recommended)

**Common Abbreviations:**
```javascript
metadata: { sourceAbbr: "CH", number: 123 }   // Church Hymnal 123
metadata: { sourceAbbr: "PD", number: 45 }    // Public Domain 45
metadata: { sourceAbbr: "HB", number: 89 }    // Hymnal Book 89
metadata: { sourceAbbr: "SS", number: 12 }    // Sunday School 12
metadata: { sourceAbbr: "YH", number: 67 }    // Youth Hymns 67
metadata: {}                                   // No abbreviation
```

**Display Format:**
```javascript
// Combined display with number
const ref = hymn.metadata?.sourceAbbr && hymn.metadata?.number
  ? `${hymn.metadata.sourceAbbr} ${hymn.metadata.number}`
  : hymn.metadata?.number || '';
  
const display = ref ? `${ref} - ${hymn.title}` : hymn.title;
// Result: "CH 123 - Amazing Grace" (when both present)
// Result: "123 - Amazing Grace" (number only)
// Result: "Amazing Grace" (neither present)
```

**Search Integration:**
```javascript
// Search by source abbreviation + number (e.g., "CH 123")
const query = "CH 123";
const matches = hymns.filter(h => {
  const ref = h.metadata?.sourceAbbr && h.metadata?.number
    ? `${h.metadata.sourceAbbr} ${h.metadata.number}`.toLowerCase()
    : '';
  return ref.includes(query.toLowerCase());
});
```

**UI Implementation Example:**
```javascript
// Render hymn list with source abbreviation
function renderHymnListItem(hymn) {
  const sourceAbbr = hymn.metadata?.sourceAbbr || '';
  const number = hymn.metadata?.number || '';
  
  let prefix = '';
  if (sourceAbbr && number) {
    prefix = `<span class="hymn-ref">${sourceAbbr} ${number}</span> `;
  } else if (number) {
    prefix = `<span class="hymn-ref">${number}</span> `;
  }
  
  return `<div class="hymn-item">
    ${prefix}
    <span class="hymn-title">${escapeHtml(hymn.title)}</span>
  </div>`;
}
// Result: <CH 123> Amazing Grace
```

**Import Behavior:**
```javascript
// CSV import with source abbreviation column
// CSV Header: Title,Author,Source Abbr,Hymn Number,Verse Text
// Example: "Amazing Grace","John Newton","CH",123,"Verse 1..."

// During import, populate both sourceAbbr and source:
hymn.metadata = {
  sourceAbbr: "CH",
  number: 123,
  source: "Church Hymnal"  // Full name from sourceAbbr mapping
};
```

**Benefits:**
- **Familiar references**: Churches identify hymns as "CH 123" not just "123"
- **Multiple sources**: Different hymn books can have same number (CH 123 vs PD 123)
- **Quick identification**: Easier to communicate which hymnal to use
- **Search friendly**: Users can search "CH 123" to find specific hymn

---

##### `source` (String)

**Usage:** Track hymn origin/source for attribution and organization

**Format:** Any string value

**Examples:**
```javascript
metadata: { source: "Public Domain" }
metadata: { source: "Hymnary.org" }
metadata: { source: "Church Hymnal Book" }
metadata: { source: "CSV Import 2024-01-06" }
metadata: {}  // No source
```

**Display in UI (Future):**
```javascript
// Could display source in hymn details
const sourceLabel = hymn.metadata?.source ? ` • ${hymn.metadata.source}` : '';
const display = `${hymn.title}${sourceLabel}`;
// Result: "Amazing Grace • Public Domain"
```

**Search Behavior:**
```javascript
// Could filter by source
if (hymn.metadata?.source?.toLowerCase().includes(query)) {
  // Matched
}
```

---

##### `category`, `key`, `tempo`

**Status:** Reserved for future use

**Current Behavior:**
- Stored in default data files
- NOT displayed in UI
- NOT edited in UI
- Preserved during import/export
- Can be added to hymns without breaking anything

**Future Enhancement:**
```javascript
// Could implement hymn filtering by category
// Could display musical key and tempo in UI
// Could recommend songs in same key
```

---

### `createdAt` (Optional, String)

**Rules:**
- ISO8601 timestamp format
- Automatically set on creation
- Not used by UI (informational only)
- Optional in validation (future removal candidate)

**Format:** `"2024-01-06T12:34:56.789Z"`

**Example:**
```javascript
createdAt: new Date().toISOString()
// Results in: "2024-01-06T14:32:18.456Z"
```

**Validation:**
```javascript
if (hymn.createdAt) {
  if (isNaN(Date.parse(hymn.createdAt))) {
    throw new Error('Invalid createdAt timestamp');
  }
}
```

---

## Validation Rules (HymnValidator)

### Complete Validation Example

```javascript
const hymn = {
  id: "hymn_1704549696123_0_a7b2c9d1",
  title: "Amazing Grace",
  author: "John Newton",
  verses: [
    "Amazing grace! How sweet the sound\nThat saved a wretch like me!",
    "'Twas grace that taught my heart to fear"
  ],
  chorus: "Amazing grace, how sweet the sound",
  metadata: { number: 1 },
  createdAt: "2024-01-06T12:34:56.789Z"
};

const { valid, errors } = HymnValidator.validateHymn(hymn);

if (!valid) {
  console.error('Validation errors:', errors);
  // errors: [] (empty = valid)
}
```

### Validation Errors

**Invalid hymn examples:**

```javascript
// Missing title
{ verses: ["Verse 1"] }
// Error: "Title is required and must be non-empty string"

// Empty verses array
{ title: "Test", verses: [] }
// Error: "At least one verse is required"

// Empty verse string
{ title: "Test", verses: [""] }
// Error: "Verse 1 is empty"

// Invalid author type
{ title: "Test", verses: ["Verse"], author: 123 }
// Error: "Author must be a string"

// Invalid metadata
{ title: "Test", verses: ["Verse"], metadata: "not an object" }
// Error: "Metadata must be an object (not array)"

// Invalid hymn number
{ title: "Test", verses: ["Verse"], metadata: { number: -5 } }
// Error: "Hymn number must be a non-negative integer"
```

---

## Data Sanitization

### Auto-Sanitization Process

HymnValidator.sanitizeHymn() performs:

1. **Trim all strings**
   ```javascript
   title: "  Amazing Grace  " → "Amazing Grace"
   author: "\n John Newton \n" → "John Newton"
   ```

2. **Clean verses (trim + remove empty)**
   ```javascript
   verses: ["Verse 1\n", "", "\nVerse 2"]
   // Becomes: ["Verse 1", "Verse 2"]
   ```

3. **Set defaults for missing optional fields**
   ```javascript
   // Missing fields are set to:
   author: ""           // Empty string
   chorus: ""           // Empty string
   metadata: {}         // Empty object
   verses: []           // (Would fail validation)
   ```

### Sanitization Example

```javascript
const dirtyHymn = {
  id: "hymn_123",
  title: "  Amazing Grace  ",
  author: "\nJohn Newton",
  verses: ["Verse 1\n\n", "", "Verse 2"],
  chorus: "  Chorus  "
};

const clean = HymnValidator.sanitizeHymn(dirtyHymn);

// Result:
{
  id: "hymn_123",
  title: "Amazing Grace",
  author: "John Newton",
  verses: ["Verse 1", "Verse 2"],  // Empty removed
  chorus: "Chorus",
  metadata: {}
}
```

---

## Service Object Model

Collection of hymns organized for worship services.

### Schema

```typescript
interface Service {
  id: string;                    // Unique identifier (immutable)
  name: string;                  // Service name (non-empty)
  hymns: string[];               // Array of hymn IDs (min 1)
  date?: string;                 // Optional ISO8601 timestamp
}
```

---

## Complete Service Example

```javascript
{
  id: "service_1704549696123_0_b8c3d0e2",
  name: "Sunday Morning Service",
  date: "2024-01-07T08:00:00.000Z",
  hymns: [
    "hymn_1704549696123_0_a7b2c9d1",  // Amazing Grace
    "hymn_1704549696124_0_b8c3d0e2",  // Jesus Loves Me
    "hymn_1704549696125_0_c9d4e1f3"   // His Eye Is on the Sparrow
  ]
}
```

---

## Service Field Definitions

### `id` (Required, String)

**Format:** `service_<timestamp>_<counter>_<random>`

**Example:** `service_1704549696123_0_b8c3d0e2`

**Rules:**
- Starts with `service_`
- Generated by `generateUniqueServiceId()` function
- Immutable
- Unique across all services

---

### `name` (Required, String)

**Rules:**
- Non-empty (after trim)
- Maximum recommended: 100 characters
- Descriptive service name

**Examples:**
- `"Sunday Morning Service"`
- `"Easter Celebration 2024"`
- `"Youth Group Worship"`

---

### `hymns` (Required, Array of Strings)

**Rules:**
- Array of hymn IDs
- Minimum 1 hymn
- Each ID must exist in hymn library (or will be skipped)
- Order matters (displayed in order)

**Format:**
```javascript
hymns: [
  "hymn_1704549696123_0_a7b2c9d1",  // Position 1
  "hymn_1704549696124_0_b8c3d0e2",  // Position 2
  "hymn_1704549696125_0_c9d4e1f3"   // Position 3
]
```

**Loading Behavior:**
```javascript
function selectService(serviceId) {
  const service = services.find(s => s.id === serviceId);
  
  // Load hymns by ID
  service.hymns.forEach(hymnId => {
    const hymn = hymns.find(h => h.id === hymnId);
    
    if (!hymn) {
      console.warn(`Hymn ${hymnId} not found (deleted?)`);
      // Silently skip if hymn was deleted
      return;
    }
    
    // Display hymn
    displayHymn(hymn);
  });
}
```

---

### `date` (Optional, String)

**Rules:**
- ISO8601 timestamp
- Represents service date/time
- Optional (not used in UI currently)

**Format:** `"2024-01-07T08:00:00.000Z"`

---

## Import/Export Formats

### TXT Import Format

```txt
Title: Amazing Grace
Author: John Newton

Amazing grace! How sweet the sound
That saved a wretch like me!
I once was lost, but now am found,
Was blind, but now I see.

'Twas grace that taught my heart to fear,
And grace my fears relieved;
How precious did that grace appear
The hour I first believed!

Chorus: Amazing grace, how sweet the sound
```

**Rules:**
- `Title:` starts new hymn (required)
- `Author:` optional
- Empty lines separate verses
- `Chorus:` marks chorus (optional)

### CSV Import Format

```csv
Title,Author,Verse Number,Verse Text,Chorus
"Amazing Grace","John Newton",1,"Amazing grace! How sweet the sound\nThat saved a wretch like me!","Amazing grace, how sweet the sound"
"Amazing Grace","John Newton",2,"'Twas grace that taught my heart to fear","Amazing grace, how sweet the sound"
```

**Rules:**
- Header row required
- Quotes required for multi-line verse text
- Multiple rows with same title = combined into one hymn
- Column names (case-insensitive): `Title`, `Author`, `Verse Number`, `Verse Text`, `Chorus`

### JSON Import Format

```json
[
  {
    "title": "Amazing Grace",
    "author": "John Newton",
    "verses": [
      "Amazing grace! How sweet the sound\nThat saved a wretch like me!",
      "'Twas grace that taught my heart to fear"
    ],
    "chorus": "Amazing grace, how sweet the sound",
    "metadata": {
      "number": 1
    }
  }
]
```

**Rules:**
- Array of hymn objects
- Must match hymn schema
- All validations apply

---

## Storage Keys (localStorage)

### Hymns Storage

**Key:** `hymnflow-hymns`  
**Type:** JSON string (serialized array)  
**Size:** ~5-50 MB (depends on library size)

```javascript
// Get all hymns
const hymns = JSON.parse(localStorage.getItem('hymnflow-hymns') || '[]');

// Save all hymns
localStorage.setItem('hymnflow-hymns', JSON.stringify(hymns));
```

### Services Storage

**Key:** `hymnflow-services`  
**Type:** JSON string (serialized array)

```javascript
// Get all services
const services = JSON.parse(localStorage.getItem('hymnflow-services') || '[]');

// Save all services
localStorage.setItem('hymnflow-services', JSON.stringify(services));
```

---

## Code Examples

### Creating a New Hymn

```javascript
const newHymn = {
  id: generateUniqueHymnId(),
  title: "Amazing Grace",
  author: "John Newton",
  verses: [
    "Amazing grace! How sweet the sound\nThat saved a wretch like me!",
    "'Twas grace that taught my heart to fear"
  ],
  chorus: "Amazing grace, how sweet the sound",
  metadata: { number: 1 },
  createdAt: new Date().toISOString()
};

// Validate
const { valid, errors } = HymnValidator.validateHymn(newHymn);
if (!valid) {
  console.error('Validation errors:', errors);
  return;
}

// Save
hymns.push(newHymn);
saveHymns();
```

### Editing a Hymn

```javascript
function editHymn(hymnId, updates) {
  const hymn = hymns.find(h => h.id === hymnId);
  if (!hymn) return;

  // Apply updates
  Object.assign(hymn, updates);

  // Validate before saving
  const { valid, errors } = HymnValidator.validateHymn(hymn);
  if (!valid) {
    throw new Error(`Validation failed: ${errors.join(', ')}`);
  }

  // Save
  saveHymns();
}

// Usage
editHymn(hymnId, {
  title: "Updated Title",
  verses: [...newVerses],
  metadata: { number: 42 }
});
```

### Creating a Service

```javascript
const newService = {
  id: generateUniqueServiceId(),
  name: "Sunday Service",
  date: new Date().toISOString(),
  hymns: [
    hymnId1,
    hymnId2,
    hymnId3
  ]
};

// Validate with hymn reference check
const { valid, errors } = HymnValidator.validateService(newService, hymns);
if (!valid) {
  console.error('Service validation errors:', errors);
  return;
}

// Save
services.push(newService);
saveServices();
```

### Exporting Hymns

```javascript
function exportHymns(hymnArray) {
  const json = JSON.stringify(hymnArray, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = 'hymns-export.json';
  a.click();
  
  URL.revokeObjectURL(url);
}

// Usage
exportHymns(hymns);
```

---

## Type Definitions (TypeScript)

```typescript
type HymnId = string & { readonly __brand: 'HymnId' };
type ServiceId = string & { readonly __brand: 'ServiceId' };

interface Hymn {
  id: HymnId;
  title: string;
  author: string;
  verses: string[];
  chorus?: string;
  metadata?: {
    number?: number;
    category?: string;
    key?: string;
    tempo?: string;
    [key: string]: any;
  };
  createdAt?: string;
}

interface Service {
  id: ServiceId;
  name: string;
  hymns: HymnId[];
  date?: string;
}

interface ValidationResult {
  valid: boolean;
  errors: string[];
}

interface ImportResult {
  valid: Hymn[];
  invalid: Array<{ index: number; hymn: any; errors: string[] }>;
}
```

---

## Best Practices

### When Creating Hymns

1. ✅ **Always validate** before saving
2. ✅ **Use ID generators** (never manually create IDs)
3. ✅ **Sanitize on import** to clean up data
4. ✅ **Check hymn exists** before adding to service

### When Editing Hymns

1. ✅ **Validate before save**
2. ✅ **Never change ID** (breaks service references)
3. ✅ **Preserve metadata** (don't lose custom fields)
4. ✅ **Trim strings** before saving

### When Creating Services

1. ✅ **Validate with hymn reference check**
2. ✅ **Use unique service IDs**
3. ✅ **Handle missing hymns gracefully** (skip silently)
4. ✅ **Maintain hymn order** for display

### When Importing Data

1. ✅ **Validate all imported hymns**
2. ✅ **Report validation errors** to user
3. ✅ **Skip invalid entries** (don't corrupt database)
4. ✅ **Generate new IDs** (don't preserve old ones)

